<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Buy high-quality oversized t-shirts in India. AsUsual offers trendy unisex graphic tees, cotton t-shirts for men & women. Free shipping on all orders. Shop now!">
    <meta name="keywords"
        content="asusual, asusua, asusual clothing, oversized t shirts india, ASUSUAL clothing, graphic tees india, cotton t shirts online, trendy streetwear india, buy t shirts online india">
    <title>Edit Products</title>
    <!-- Favicons -->
    <link rel="icon" href="/assests/favicon.png" type="image/x-icon" sizes="any">
    <link rel="icon" href="/assests/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/assests/apple-touch-icon.png">
    <link rel="manifest" href="/assests/site.webmanifest">
    <meta name="theme-color" content="#ffffff">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body class="bg-gray-100">
    <div class="min-h-screen flex flex-col md:flex-row">
        <!-- Sidebar - Same as dashboard -->

        <%- include('../partials/admin-navbar', { activePage: activePage }) %>

            <!-- Main Content -->
            <div class="flex-1 p-8">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-semibold text-gray-800">Edit Products</h1>
                </div>

                <div class="space-y-6">
                    <% products.forEach(product=> { %>
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <div class="flex flex-col md:flex-row gap-6">
                                <% if (product.front_image) { %>
                                    <div class="w-full md:w-1/3">
                                        <img src="<%= product.front_image %>" alt="<%= product.name %>"
                                            class="w-full h-auto rounded-lg object-cover">
                                    </div>
                                    <% } %>

                                        <div class="flex-1">
                                            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                                                <%= product.name %>
                                            </h2>

                                            <form action="/products/edit-product/<%= product._id %>" method="POST"
                                                enctype="multipart/form-data" class="space-y-4">

                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div>
                                                        <label
                                                            class="block text-sm font-medium text-gray-700 mb-1">Product
                                                            Name</label>
                                                        <input type="text" name="name" value="<%= product.name %>"
                                                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                                    </div>
                                                    <div>
                                                        <label
                                                            class="block text-sm font-medium text-gray-700 mb-1">MRP</label>
                                                        <input type="number" name="MRP" value="<%= product.MRP %>"
                                                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                                    </div>
                                                    <div>
                                                        <label
                                                            class="block text-sm font-medium text-gray-700 mb-1">Price</label>
                                                        <input type="number" name="price" value="<%= product.price %>"
                                                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                                    </div>
                                                    <div>
                                                        <label
                                                            class="block text-sm font-medium text-gray-700 mb-1">Brand</label>
                                                        <input type="text" name="brand" value="<%= product.brand %>"
                                                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                                    </div>
                                                    <div>
                                                        <label
                                                            class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                                        <input type="text" name="category"
                                                            value="<%= product.category || '' %>"
                                                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                                    </div>
                                                </div>
                                                <!-- Category Type -->
                                                <div>
                                                    <label for="categoryType"
                                                        class="block text-sm font-medium text-gray-700 mb-1">Category
                                                        Type</label>
                                                    <select id="categoryType-<%= product._id %>" name="categoryType"
                                                        class="w-full px-4 py-2 border border-gray-300 rounded-md text-black focus:ring-indigo-500 focus:border-indigo-500">
                                                        <option value="">Select Category Type</option>
                                                    </select>

                                                </div>

                                                <!-- Colors Section -->
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">Colors &
                                                        Images</label>

                                                    <div id="colors-container-<%= product._id %>"
                                                        class="space-y-3 mb-4">
                                                        <% if (product.color && product.color.length> 0) { %>
                                                            <% product.color.forEach(function(col, idx) { %>
                                                                <div class="border rounded-md p-3 bg-gray-50 space-y-2"
                                                                    id="color-block-<%= product._id %>-<%= idx %>">
                                                                    <div class="flex justify-between items-center">
                                                                        <span class="font-semibold text-black">
                                                                            <%= col %>
                                                                        </span>
                                                                        <button type="button"
                                                                            class="text-red-500 hover:text-red-700"
                                                                            onclick="removeColor('<%= product._id %>', '<%= col %>')">
                                                                            <i class="fas fa-times"></i>
                                                                        </button>
                                                                    </div>

                                                                    <!-- 🎨 COLOR PICKER -->
                                                                    <div class="flex items-center gap-2">
                                                                        <label class="text-sm text-gray-600">Pick
                                                                            Color:</label>
                                                                        <input type="color" name="colorCode_<%= col %>"
                                                                            value="<%= (product.colorImages.find(c=>c.color === col)?.colorCode) || '#000000' %>"
                                                                            class="w-10 h-8 border rounded" />
                                                                    </div>

                                                                    <!-- 🖼️ File upload -->
                                                                    <div>
                                                                        <label
                                                                            class="block text-sm text-gray-600">Upload
                                                                            Images for <%= col %>:</label>
                                                                        <input type="file" name="colorImages_<%= col %>"
                                                                            id="colorImages-<%= product._id %>-<%= col %>"
                                                                            multiple accept="image/*"
                                                                            class="w-full mt-1 border border-gray-300 rounded-md p-2 text-black" />
                                                                    </div>
                                                                </div>

                                                                <% }) %>
                                                                    <% } %>
                                                    </div>

                                                    <div class="flex gap-2">
                                                        <input type="text" id="newColor-<%= product._id %>"
                                                            placeholder="Enter color name"
                                                            class="flex-1 px-4 py-2 border border-gray-300 rounded-md text-black focus:ring-indigo-500 focus:border-indigo-500" />
                                                        <button type="button" onclick="addColor('<%= product._id %>')"
                                                            class="px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
                                                            Add
                                                        </button>
                                                    </div>

                                                    <!-- Hidden input to hold color array -->
                                                    <input type="hidden" name="color" id="colorInput-<%= product._id %>"
                                                        value='<%= JSON.stringify(product.color || []) %>' />

                                                    <!-- Hidden input to hold deleted colors -->
                                                    <input type="hidden" name="deletedColors"
                                                        id="deletedColors-<%= product._id %>" value="[]">
                                                </div>


                                                <div>
                                                    <label
                                                        class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                                    <textarea name="description" rows="3"
                                                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"><%= product.description || '' %></textarea>
                                                </div>

                                                <div class="border-t pt-4">
                                                    <h3 class="text-lg font-medium text-gray-700 mb-3">Size Quantities
                                                    </h3>
                                                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
                                                        <div>
                                                            <label
                                                                class="block text-sm font-medium text-gray-700 mb-1">X-Small</label>
                                                            <input type="number" name="sizes[xsmall]"
                                                                value="<%= product.sizes.xsmall %>"
                                                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                                        </div>
                                                        <div>
                                                            <label
                                                                class="block text-sm font-medium text-gray-700 mb-1">Small</label>
                                                            <input type="number" name="sizes[small]"
                                                                value="<%= product.sizes.small %>"
                                                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                                        </div>
                                                        <div>
                                                            <label
                                                                class="block text-sm font-medium text-gray-700 mb-1">Medium</label>
                                                            <input type="number" name="sizes[medium]"
                                                                value="<%= product.sizes.medium %>"
                                                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                                        </div>
                                                        <div>
                                                            <label
                                                                class="block text-sm font-medium text-gray-700 mb-1">Large</label>
                                                            <input type="number" name="sizes[large]"
                                                                value="<%= product.sizes.large %>"
                                                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                                        </div>
                                                        <div>
                                                            <label
                                                                class="block text-sm font-medium text-gray-700 mb-1">X-Large</label>
                                                            <input type="number" name="sizes[xlarge]"
                                                                value="<%= product.sizes.xlarge %>"
                                                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                                        </div>
                                                        <div>
                                                            <label
                                                                class="block text-sm font-medium text-gray-700 mb-1">XX-Large</label>
                                                            <input type="number" name="sizes[xxlarge]"
                                                                value="<%= product.sizes.xxlarge %>"
                                                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label>Best Seller:</label><br>
                                                    <label>
                                                        <input type="radio" name="bestseller" value="true"
                                                            <%=product.bestseller ? 'checked' : '' %> /> Yes
                                                    </label>
                                                    <label>
                                                        <input type="radio" name="bestseller" value="false"
                                                            <%=!product.bestseller ? 'checked' : '' %> /> No
                                                    </label>
                                                </div>

                                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                    <div>
                                                        <label
                                                            class="block text-sm font-medium text-gray-700 mb-1">Front
                                                            Image</label>
                                                        <input type="file" name="front_image" accept="image/*"
                                                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                                    </div>
                                                    <div>
                                                        <label class="block text-sm font-medium text-gray-700 mb-1">Back
                                                            Image</label>
                                                        <input type="file" name="back_image" accept="image/*"
                                                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                                    </div>
                                                    <div>
                                                        <label
                                                            class="block text-sm font-medium text-gray-700 mb-1">Additional
                                                            Images</label>
                                                        <input type="file" name="images" accept="image/*" multiple
                                                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                                    </div>
                                                </div>


                                                <div class="flex justify-end gap-3 pt-4 border-t">
                                                    <button type="submit"
                                                        class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition flex items-center gap-2">
                                                        <i class="fas fa-save"></i> Update
                                                    </button>
                                                    <button type="button" onclick="confirmDelete('<%= product._id %>')"
                                                        class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition flex items-center gap-2">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                </div>

                                            </form>

                                            <form id="deleteForm-<%= product._id %>"
                                                action="/products/delete/<%= product._id %>" method="POST"
                                                class="hidden">
                                            </form>
                                        </div>
                            </div>
                        </div>
                        <% }) %>
                </div>
            </div>
    </div>

    <script>
        function confirmDelete(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                document.getElementById('deleteForm-' + productId).submit();
            }
        }
        // ==================== CATEGORY TYPE ====================
        async function loadCategories(productId, selectedId) {
            try {
                const res = await fetch('/category/all');
                const data = await res.json();

                if (data.success) {
                    const select = document.getElementById(`categoryType-${productId}`);
                    data.categories.forEach(cat => {
                        const opt = document.createElement('option');
                        opt.value = cat._id;
                        opt.textContent = cat.name;
                        if (selectedId && selectedId === cat._id.toString()) opt.selected = true;
                        select.appendChild(opt);
                    });
                }
            } catch (err) {
                console.error('Error loading categories:', err);
            }
        }

        // Load categories for all products
        document.addEventListener('DOMContentLoaded', () => {
  <% products.forEach(product => { %>
            loadCategories('<%= product._id %>', '<%= product.categoryType ? product.categoryType._id.toString() : "" %>');

  <% }) %>
});

        // ==================== COLOR MANAGEMENT ====================
        function addColor(productId) {
            const input = document.getElementById(`newColor-${productId}`);
            const colorContainer = document.getElementById(`colors-container-${productId}`);
            const hiddenInput = document.getElementById(`colorInput-${productId}`);
            const color = input.value.trim();

            if (!color) return alert("Enter a color name!");

            const currentColors = JSON.parse(hiddenInput.value || "[]");
            if (currentColors.includes(color)) return alert("Color already exists!");

            currentColors.push(color);
            hiddenInput.value = JSON.stringify(currentColors);

            const div = document.createElement("div");
            div.className = "border rounded-md p-3 bg-gray-50 space-y-2";
            div.id = `color-block-${productId}-${color}`;

            div.innerHTML = `
<div class="flex justify-between items-center">
  <span class="font-semibold text-black">${color}</span>
  <button type="button" class="text-red-500 hover:text-red-700"
    onclick="removeColor('${productId}', '${color}')">
    <i class='fas fa-times'></i>
  </button>
</div>

<!-- 🎨 COLOR PICKER -->
<div class="flex items-center gap-2">
  <label class="text-sm text-gray-600">Pick Color:</label>
  <input 
    type="color"
    name="colorCode_${color}"
    value="#000000"
    class="w-10 h-8 border rounded"
  />
</div>

<div>
  <label class="block text-sm text-gray-600">Upload Images for ${color}:</label>
  <input
    type="file"
    name="colorImages_${color}"
    id="colorImages-${productId}-${color}"
    multiple
    accept="image/*"
    class="w-full mt-1 border border-gray-300 rounded-md p-2 text-black"
  />
</div>
`;


            colorContainer.appendChild(div);
            input.value = "";
        }

        function removeColor(productId, color) {
            // 1️⃣ Find the color block container and hide it
            const colorBlock = document.getElementById(`color-block-${productId}-${color}`);
            if (colorBlock) {
                colorBlock.style.display = "none"; // hide instantly
            }

            // 2️⃣ Update the hidden JSON fields so backend knows which color to delete
            const colorInput = document.getElementById(`colorInput-${productId}`);
            const deletedInput = document.getElementById(`deletedColors-${productId}`);

            if (colorInput) {
                let colors = JSON.parse(colorInput.value || "[]");
                colors = colors.filter(c => c !== color);
                colorInput.value = JSON.stringify(colors);
            }

            if (deletedInput) {
                let deleted = JSON.parse(deletedInput.value || "[]");
                if (!deleted.includes(color)) {
                    deleted.push(color);
                }
                deletedInput.value = JSON.stringify(deleted);
            }
        }




    </script>
</body>

</html>