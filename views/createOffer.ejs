<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create Offer | Admin</title>
  <style>
    body {
      font-family: 'Inter', 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f7f9fc, #eef1f7);
      margin: 0;
      padding: 40px 20px;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      font-size: 2rem;
      margin-bottom: 30px;
    }

    /* Card form style */
    form {
      background: #fff;
      border-radius: 12px;
      padding: 30px 40px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      max-width: 750px;
      margin: 0 auto 60px;
    }

    label {
      font-weight: 600;
      margin-top: 14px;
      display: block;
      color: #444;
    }

    select, input {
      width: 100%;
      padding: 10px 12px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 15px;
      transition: all 0.2s ease;
    }

    select:focus, input:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      outline: none;
    }

    button {
      display: inline-block;
      margin-top: 20px;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s ease;
    }

    #addProductBtn {
      background: #28a745;
      color: #fff;
    }

    #addProductBtn:hover {
      background: #218838;
    }

    button[type="submit"] {
      background: #007bff;
      color: white;
      width: 100%;
    }

    button[type="submit"]:hover {
      background: #0056b3;
    }

    .product-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .product-selector img {
      width: 55px;
      height: 55px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #ddd;
      transition: transform 0.2s ease;
    }

    .product-selector img:hover {
      transform: scale(1.05);
    }

    .remove-btn {
      background: #dc3545;
      border: none;
      color: #fff;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 14px;
    }

    .remove-btn:hover {
      background: #b52a37;
    }

    hr {
      border: none;
      border-top: 2px solid #eee;
      margin: 50px auto;
      width: 80%;
    }

    h2 {
      text-align: center;
      color: #2c3e50;
      font-size: 1.7rem;
      margin-bottom: 25px;
    }

    /* Table Styling */
    table {
      border-collapse: collapse;
      width: 95%;
      margin: 0 auto;
      background: #fff;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 14px 18px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }

    th {
      background-color: #f9fafc;
      color: #555;
      text-transform: uppercase;
      font-size: 13px;
      letter-spacing: 0.5px;
    }

    td img {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      object-fit: cover;
      border: 1px solid #ddd;
    }

    tr:hover {
      background-color: #fafafa;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge.active {
      background: #d4edda;
      color: #155724;
    }

    .badge.inactive {
      background: #f8d7da;
      color: #721c24;
    }

    .actions button {
      margin-right: 6px;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn-edit {
      background: #17a2b8;
      color: white;
    }

    .btn-edit:hover {
      background: #138496;
    }

    .btn-toggle {
      background: #ffc107;
      color: #222;
    }

    .btn-toggle:hover {
      background: #e0a800;
    }

    .btn-delete {
      background: #dc3545;
      color: white;
    }

    .btn-delete:hover {
      background: #c82333;
    }

    @media(max-width: 768px) {
      form {
        padding: 20px;
      }
      table {
        font-size: 14px;
      }
      td, th {
        padding: 10px;
      }
    }
  </style>
</head>
<body>

  <h1>üéÅ Create New Offer</h1>

  <!-- CREATE OFFER FORM -->
  <form action="/offers" method="POST">
    <label for="name">Offer Name</label>
    <input type="text" id="name" name="name" required placeholder="Buy 3 T-Shirts, Get 1 Free">

    <label>Products (for offer)</label>
    <div id="productsContainer">
      <div class="product-selector">
        <select name="productIds" class="product-dropdown" onchange="updateProductImage(this)" required>
          <option value="">-- Select Product --</option>
          <% products.forEach(product => { %>
            <option value="<%= product._id %>" data-image="<%= product.front_image %>">
              <%= product.name %> ‚Äî ‚Çπ<%= product.price %>
            </option>
          <% }) %>
        </select>
        <img src="" alt="Preview" class="preview" />
        <button type="button" class="remove-btn" onclick="removeProduct(this)">‚úï</button>
      </div>
    </div>

    <button type="button" id="addProductBtn" onclick="addProduct()">+ Add Another Product</button>

    <label for="minQuantity">Minimum Quantity</label>
    <input type="number" id="minQuantity" name="minQuantity" placeholder="e.g., 3" required>

    <label for="offerType">Offer Type</label>
    <select id="offerType" name="offerType" required onchange="toggleOfferFields()">
      <option value="">-- Select Offer Type --</option>
      <option value="free_item">Free Item</option>
      <option value="flat_discount">Flat Discount</option>
      <option value="percentage_discount">Percentage Discount</option>
    </select>

    <div id="offerValueSection">
      <label for="offerValue">Offer Value (‚Çπ or %)</label>
      <input type="number" id="offerValue" name="offerValue" placeholder="Leave empty for 'free item'">
    </div>

    <div id="freeProductSection" style="display:none;">
      <label for="freeProductId">Free Product</label>
      <select id="freeProductId" name="freeProductId">
        <option value="">-- None --</option>
        <% products.forEach(product => { %>
          <option value="<%= product._id %>" data-image="<%= product.front_image %>">
            <%= product.name %>
          </option>
        <% }) %>
      </select>
    </div>

    <label for="expiryDate">Expiry Date</label>
    <input type="date" id="expiryDate" name="expiryDate" required>

    <button type="submit">Create Offer</button>
  </form>

  <hr>

  <h2>üì¶ Current Offers</h2>

  <% if (offers && offers.length > 0) { %>
    <table>
      <thead>
        <tr>
          <th>Offer Name</th>
          <th>Products</th>
          <th>Offer Type</th>
          <th>Offer Value</th>
          <th>Expiry Date</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% offers.forEach(o => { %>
          <tr>
            <td><%= o.name %></td>
            <td>
              <% o.productIds.forEach(p => { %>
                <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
                  <span><%= p.name %></span>
                </div>
              <% }) %>
            </td>
            <td><%= o.offerType.replace('_',' ') %></td>
            <td>
              <% if (o.offerType === 'free_item' && o.freeProductId) { %>
                üéÅ Free: <%= o.freeProductId.name %>
              <% } else if (o.offerType === 'flat_discount') { %>
                ‚Çπ<%= o.offerValue %> off
              <% } else if (o.offerType === 'percentage_discount') { %>
                <%= o.offerValue %>% off
              <% } else { %> - <% } %>
            </td>
            <td><%= o.expiryDate.toISOString().substring(0, 10) %></td>
            <td>
              <span class="badge <%= o.active ? 'active' : 'inactive' %>">
                <%= o.active ? 'Active' : 'Inactive' %>
              </span>
            </td>
            <td class="actions">
              <form action="/offers/edit/<%= o._id %>" method="GET" style="display:inline;">
                <button class="btn-edit" type="submit">‚úèÔ∏è Edit</button>
              </form>
              <form action="/offers/toggle-active/<%= o._id %>" method="POST" style="display:inline;">
                <button class="btn-toggle" type="submit">
                  <%= o.active ? 'Deactivate' : 'Activate' %>
                </button>
              </form>
              <form action="/offers/delete/<%= o._id %>" method="POST" style="display:inline;" onsubmit="return confirm('Delete this offer?')">
                <button class="btn-delete" type="submit">üóë Delete</button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } else { %>
    <div style="text-align:center; color:#555; margin-top:20px;">
      No active offers found. Create one above.
    </div>
  <% } %>

  <script>
    const products = <%- JSON.stringify(products) %>;

    function addProduct() {
      const container = document.getElementById('productsContainer');
      const newSelector = document.createElement('div');
      newSelector.classList.add('product-selector');

      let optionsHTML = '<option value="">-- Select Product --</option>';
      products.forEach(p => {
        optionsHTML += `<option value="${p._id}" data-image="${p.front_image}">${p.name} ‚Äî ‚Çπ${p.price}</option>`;
      });

      newSelector.innerHTML = `
        <select name="productIds" class="product-dropdown" onchange="updateProductImage(this)" required>
          ${optionsHTML}
        </select>
        <img src="" alt="Preview" class="preview" />
        <button type="button" class="remove-btn" onclick="removeProduct(this)">‚úï</button>
      `;

      container.appendChild(newSelector);
      updateMinQuantity();
    }

    function removeProduct(button) {
      button.parentElement.remove();
      updateMinQuantity();
    }

    function updateProductImage(select) {
      const selectedOption = select.options[select.selectedIndex];
      const imageSrc = selectedOption.getAttribute('data-image');
      const img = select.parentElement.querySelector('.preview');
      img.src = imageSrc || '';
    }

    function updateMinQuantity() {
      const count = document.querySelectorAll('.product-selector').length;
      document.getElementById('minQuantity').value = count;
    }

    function toggleOfferFields() {
      const type = document.getElementById('offerType').value;
      const offerValueSection = document.getElementById('offerValueSection');
      const freeProductSection = document.getElementById('freeProductSection');

      if (type === 'free_item') {
        offerValueSection.style.display = 'none';
        freeProductSection.style.display = 'block';
      } else {
        offerValueSection.style.display = 'block';
        freeProductSection.style.display = 'none';
      }
    }
  </script>
</body>
</html>
